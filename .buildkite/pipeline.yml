steps:
  - label: ":docker: build image"
    key: image
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            containers:
              - name: docker
                image: crazymax/docker:latest
                command: [.buildkite/steps/image.sh]
                volumeMounts:
                - name: buildkit-client
                  mountPath: /buildkit/certs
            volumes:
            - name: buildkit-client
              secret:
                secretName: buildkit-client-certs
  - label: "print image result"
    depends_on: image
    agents:
      queue: kubernetes
    env:
      BUILDKITE_SHELL: /bin/sh -e
    plugins:
      - kubernetes:
          podSpec:
            containers:
              - name: busybox
                image: busybox:latest
                command:
                - buildkite-agent
                args:
                - meta-data
                - get
                - "image"
